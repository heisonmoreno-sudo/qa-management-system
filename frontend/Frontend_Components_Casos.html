<!-- ═══════════════════════════════════════════════════════════════════════════
     FRONTEND_COMPONENTS_CASOS.HTML
     Componente de UI para gestión de casos de prueba
     VERSIÓN 3.0: Mover casos entre hojas + IDs simplificados
     ═══════════════════════════════════════════════════════════════════════════ -->

<style>
  /* ─────────────────────────────────────────────────────────────────────────── */
  /* ESTILOS ESPECÍFICOS DE CASOS                                                */
  /* ─────────────────────────────────────────────────────────────────────────── */
  
  .casos-container {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .breadcrumb {
    padding: 1rem 0;
    font-size: 0.9rem;
    color: #64748b;
  }
  
  .breadcrumb a {
    color: #3b82f6;
    text-decoration: none;
  }
  
  .breadcrumb a:hover {
    text-decoration: underline;
  }
  
  .filtros-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .input-group label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #475569;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }
  
  .checkbox-group input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }
  
  .advertencia-hoja {
    background: #fef3c7 !important;
    border-left: 4px solid #f59e0b !important;
    padding: 0.75rem;
    border-radius: 6px;
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }
  
  .table th:nth-child(6),
  .table td:nth-child(6),
  .table th:nth-child(7),
  .table td:nth-child(7) {
    text-align: center;
    width: 80px;
  }
  
  .indicador-critico,
  .indicador-regresion {
    font-size: 1.2rem;
  }
  
  .caso-eliminado {
    opacity: 0.6;
    background: #fee2e2 !important;
  }
  
  .btn-icon {
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    line-height: 1;
    min-width: auto;
  }
  
  .detalle-grid {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .detalle-label {
    font-weight: 600;
    color: #475569;
  }
  
  .detalle-valor {
    color: #1e293b;
  }
  
  .detalle-seccion {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
  }
  
  .detalle-seccion-titulo {
    font-size: 1.1rem;
    font-weight: 700;
    color: #334155;
    margin-bottom: 1rem;
  }
</style>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- PANTALLA DE CASOS                                                           -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<div id="casosScreen" class="casos-container hidden">
  <div class="breadcrumb">
    🏠 <a href="#" onclick="volverAlDashboard(); return false;">Inicio</a> &gt; Casos
  </div>

  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="font-size: 1.75rem; font-weight: 700;">📋 Gestión de Casos</h2>
      <button class="btn btn-primary" onclick="abrirModalCrearCaso()">
        <span>➕</span>
        <span>Crear Caso</span>
      </button>
    </div>

    <div class="filtros-container">
      <div class="input-group">
        <label>🔍 Buscar por título</label>
        <input type="text" id="filtroBusqueda" class="form-input" placeholder="Buscar..." onkeyup="aplicarFiltrosEnTiempoReal()">
      </div>
      
      <div class="input-group">
        <label>📂 Hoja/Módulo</label>
        <select id="filtroHoja" class="form-select" onchange="aplicarFiltrosEnTiempoReal()">
          <option value="Todas">Todas las hojas</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>⚡ Prioridad</label>
        <select id="filtroPrioridad" class="form-select" onchange="aplicarFiltrosEnTiempoReal()">
          <option value="Todas">Todas</option>
          <option value="Critica">Crítica</option>
          <option value="Alta">Alta</option>
          <option value="Media">Media</option>
          <option value="Baja">Baja</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>📊 Estado</label>
        <select id="filtroEstado" class="form-select" onchange="aplicarFiltrosEnTiempoReal()">
          <option value="Todos">Todos</option>
          <option value="OK">OK</option>
          <option value="No_OK">No_OK</option>
          <option value="Pendiente">Pendiente</option>
          <option value="En diseno">En diseño</option>
        </select>
      </div>
    </div>

    <div style="display: flex; gap: 2rem; margin-bottom: 1rem; flex-wrap: wrap;">
      <div class="checkbox-group">
        <input type="checkbox" id="filtroFlujoCritico" onchange="aplicarFiltrosEnTiempoReal()">
        <label for="filtroFlujoCritico">⭐ Solo flujos críticos</label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="filtroCandidatosRegresion" onchange="aplicarFiltrosEnTiempoReal()">
        <label for="filtroCandidatosRegresion">🔄 Solo candidatos a regresión</label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="filtroMostrarEliminados" onchange="toggleMostrarEliminados()">
        <label for="filtroMostrarEliminados">👻 Mostrar eliminados</label>
      </div>
    </div>
  </div>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Hoja/Módulo</th>
          <th>Título</th>
          <th>Prioridad</th>
          <th>Estado</th>
          <th>Crítico</th>
          <th>Regresión</th>
          <th style="width: 180px;">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaCasos">
        <tr>
          <td colspan="8" style="text-align: center; padding: 2rem; color: #64748b;">
            Cargando casos...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- MODAL DETALLE CASO                                                          -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<div id="modalDetalleCaso" class="modal-overlay">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">
        <span id="detalleCasoIcono">📋</span>
        <span id="detalleCasoTitulo">Detalle del Caso</span>
      </h3>
      <button class="modal-close" onclick="cerrarModal('modalDetalleCaso')">✕</button>
    </div>

    <div class="modal-body">
      <div id="detalleCasoContenido">
        <!-- Contenido dinámico -->
      </div>
    </div>

    <div class="modal-footer">
      <button id="btnEditarCasoDetalle" class="btn btn-primary" onclick="editarCasoDesdeDetalle()">
        ✏️ Editar
      </button>
      <button id="btnEliminarCasoDetalle" class="btn btn-danger" onclick="eliminarCasoDesdeDetalle()">
        🗑️ Eliminar
      </button>
      <button id="btnRestaurarCasoDetalle" class="btn btn-success hidden" onclick="restaurarCasoDesdeDetalle()">
        ↩️ Restaurar
      </button>
      <button class="btn btn-secondary" onclick="cerrarModal('modalDetalleCaso')">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- MODAL CREAR/EDITAR CASO                                                     -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<div id="modalCrearCaso" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="tituloModalCaso">➕ Nuevo Caso de Prueba</h3>
      <button class="modal-close" onclick="cerrarModalCaso()">✕</button>
    </div>

    <div class="modal-body">
      <form id="formCrearCaso" onsubmit="guardarCaso(); return false;">
        <input type="hidden" id="casoIdEdicion" value="">
        <input type="hidden" id="casoHojaOriginal" value="">
        
        <div class="form-group">
          <label class="form-label">Hoja/Módulo</label>
          <select id="casoHoja" class="form-select" onchange="manejarCambioHoja()">
            <option value="">Usar hoja "Casos" (default)</option>
          </select>
          <p class="form-help">Si no seleccionas una hoja, el caso se guardará en "Casos"</p>
          
          <div id="advertenciaHoja" class="advertencia-hoja hidden">
            <strong>⚠️ No has seleccionado una hoja</strong><br>
            El caso se guardará en la hoja "Casos" por defecto.
          </div>
        </div>

        <div class="form-group">
          <label class="form-label required">Formato</label>
          <select id="casoFormato" class="form-select" required onchange="cambiarFormatoCaso()">
            <option value="Clasico">Clásico</option>
            <option value="Gherkin">Gherkin</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required">Título (mín. 10 caracteres)</label>
          <input type="text" id="casoTitulo" class="form-input" required minlength="10" placeholder="Ej: Login con usuario válido">
        </div>

        <div class="form-group">
          <label class="form-label required">Descripción (mín. 10 caracteres)</label>
          <textarea id="casoDescripcion" class="form-textarea" required minlength="10" placeholder="Descripción detallada..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label required">Prioridad</label>
          <select id="casoPrioridad" class="form-select" required>
            <option value="Critica">🔴 Crítica</option>
            <option value="Alta">🟠 Alta</option>
            <option value="Media">🟡 Media</option>
            <option value="Baja">🟢 Baja</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo de Prueba</label>
          <select id="casoTipoPrueba" class="form-select">
            <option value="Funcional">Funcional</option>
            <option value="Happy Path">Happy Path</option>
            <option value="Edge Case">Edge Case</option>
            <option value="API">API</option>
            <option value="Performance">Performance</option>
          </select>
        </div>

        <div id="camposClasico">
          <div class="form-group">
            <label class="form-label required">Pasos</label>
            <textarea id="casoPasos" class="form-textarea" placeholder="1. Paso uno&#10;2. Paso dos&#10;3. Paso tres..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label required">Resultado Esperado</label>
            <textarea id="casoResultadoEsperado" class="form-textarea" placeholder="Describe el resultado esperado..."></textarea>
          </div>
        </div>

        <div id="camposGherkin" class="hidden">
          <div class="form-group">
            <label class="form-label required">Given (Dado)</label>
            <textarea id="casoGiven" class="form-textarea" placeholder="Dado que el usuario está en la página de login"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label required">When (Cuando)</label>
            <textarea id="casoWhen" class="form-textarea" placeholder="Cuando ingresa credenciales válidas"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label required">Then (Entonces)</label>
            <textarea id="casoThen" class="form-textarea" placeholder="Entonces debe ser redirigido al dashboard"></textarea>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Precondiciones</label>
          <textarea id="casoPrecondiciones" class="form-textarea" placeholder="Condiciones previas necesarias..."></textarea>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="casoFlujoCritico">
            <label for="casoFlujoCritico">⭐ Flujo Crítico</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="casoCandidatoRegresion">
            <label for="casoCandidatoRegresion">🔄 Candidato a Regresión</label>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="submit" form="formCrearCaso" class="btn btn-primary">
        💾 Guardar Caso
      </button>
      <button type="button" class="btn btn-secondary" onclick="cerrarModalCaso()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- MODAL CREAR NUEVA HOJA                                                      -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<div id="modalCrearHoja" class="modal-overlay">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h3 class="modal-title">📑 Crear Nueva Hoja</h3>
      <button class="modal-close" onclick="cerrarModalCrearHoja()">✕</button>
    </div>

    <div class="modal-body">
      <form id="formCrearHoja" onsubmit="crearHojaNueva(); return false;">
        
        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <strong style="display: block; margin-bottom: 0.5rem;">📋 Hojas existentes:</strong>
          <div id="listaHojasExistentes" style="color: #64748b; font-size: 0.9rem;">
            Cargando...
          </div>
        </div>

        <div class="form-group">
          <label class="form-label required">Nombre de la hoja</label>
          <input 
            type="text" 
            id="nombreNuevaHoja" 
            class="form-input" 
            required 
            placeholder="Ej: Login, Pagos, Carrito"
            minlength="2"
            maxlength="50"
            oninput="validarNombreHoja()"
          >
          
          <div id="advertenciaNombreHoja" class="hidden advertencia-hoja">
            <strong>⚠️ Nombre similar detectado</strong>
            <p id="mensajeNombreSimilar" style="margin: 0.25rem 0 0 0;"></p>
          </div>
          
          <p class="form-help">
            Se creará una nueva pestaña en tu Google Sheet
          </p>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="submit" form="formCrearHoja" class="btn btn-primary" id="btnCrearHoja">
        ✅ Crear Hoja
      </button>
      <button type="button" class="btn btn-secondary" onclick="cerrarModalCrearHoja()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- MODAL CONFIRMACIÓN PERSONALIZADO                                            -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<div id="modalConfirmApp" class="modal-overlay">
  <div class="modal" style="max-width: 450px;">
    <div class="modal-header" style="border-bottom: none;">
      <h3 class="modal-title">
        <span id="confirmAppIcon">⚠️</span>
        <span id="confirmAppTitle">Confirmar</span>
      </h3>
    </div>
    
    <div class="modal-body">
      <p id="confirmAppMessage" style="color: #64748b; font-size: 1rem; line-height: 1.6;">
        ¿Deseas continuar?
      </p>
    </div>
    
    <div class="modal-footer" style="border-top: none;">
      <button id="confirmAppBtnOk" class="btn btn-primary">
        Aceptar
      </button>
      <button id="confirmAppBtnCancel" class="btn btn-secondary">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- SCRIPTS - VERSIÓN 3.0 CON MOVER CASOS                                       -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->

<script>
  // ===================================================================
  // VARIABLES GLOBALES
  // ===================================================================
  
  (function() {
    if (!window.casosActuales) window.casosActuales = [];
    if (!window.casosFiltrados) window.casosFiltrados = [];
    if (!window.currentSheetUrl) window.currentSheetUrl = null;
    if (!window.hojasExistentesGlobal) window.hojasExistentesGlobal = [];
    if (!window.formularioTieneCambios) window.formularioTieneCambios = false;
    if (!window.casoActualDetalle) window.casoActualDetalle = null;
    if (!window.mostrarEliminados) window.mostrarEliminados = false;
    
    console.log('✅ Variables globales de Casos inicializadas');
  })();

  // ===================================================================
  // FUNCIONES AUXILIARES PARA MANEJO DE URL
  // ===================================================================
  
  function guardarCurrentSheetUrl(url) {
    console.log('💾 Guardando currentSheetUrl:', url);
    window.currentSheetUrl = url;
    
    try {
      sessionStorage.setItem('qaSheetUrl', url);
    } catch (e) {
      console.warn('No se pudo guardar en sessionStorage:', e);
    }
  }
  
  function recuperarSheetUrl() {
    if (window.currentSheetUrl) {
      return window.currentSheetUrl;
    }
    
    try {
      const urlFromStorage = sessionStorage.getItem('qaSheetUrl');
      if (urlFromStorage) {
        window.currentSheetUrl = urlFromStorage;
        return urlFromStorage;
      }
    } catch (e) {
      console.warn('No se pudo leer de sessionStorage:', e);
    }
    
    const inputUrl = document.getElementById('sheetUrlInput');
    if (inputUrl && inputUrl.value) {
      return inputUrl.value.trim();
    }
    
    console.error('❌ No se pudo recuperar la URL del Sheet');
    return null;
  }

  // ===================================================================
  // SISTEMA DE CONFIRMACIÓN
  // ===================================================================
  
  // ===================================================================
  // SISTEMA DE CONFIRMACIÓN - FIX PROPAGACIÓN
  // ===================================================================
  
  function mostrarConfirmacionApp(opciones) {
    return new Promise((resolve) => {
      document.getElementById('confirmAppIcon').textContent = opciones.icono || '⚠️';
      document.getElementById('confirmAppTitle').textContent = opciones.titulo || 'Confirmar';
      document.getElementById('confirmAppMessage').innerHTML = opciones.mensaje || '¿Deseas continuar?';
      document.getElementById('confirmAppBtnOk').textContent = opciones.textoOk || 'Aceptar';
      document.getElementById('confirmAppBtnCancel').textContent = opciones.textoCancelar || 'Cancelar';
      
      const modal = document.getElementById('modalConfirmApp');
      modal.classList.add('active');
      
      // CRÍTICO: Prevenir scroll pero NO modificar overflow aquí
      // para evitar conflictos con el modal de casos
      
      // Limpiar listeners previos
      const btnOk = document.getElementById('confirmAppBtnOk');
      const btnCancel = document.getElementById('confirmAppBtnCancel');
      
      const newBtnOk = btnOk.cloneNode(true);
      const newBtnCancel = btnCancel.cloneNode(true);
      btnOk.parentNode.replaceChild(newBtnOk, btnOk);
      btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);
      
      // Handlers con stopPropagation
      newBtnOk.onclick = function(e) {
        e.stopPropagation();
        e.preventDefault();
        modal.classList.remove('active');
        resolve(true);
      };
      
      newBtnCancel.onclick = function(e) {
        e.stopPropagation();
        e.preventDefault();
        modal.classList.remove('active');
        resolve(false);
      };
      
      // Prevenir que clicks dentro del modal se propaguen
      modal.onclick = function(e) {
        if (e.target === modal) {
          // Click en el overlay del modal de confirmación - no hacer nada
          e.stopPropagation();
          e.preventDefault();
        }
      };
    });
  }

  // ===================================================================
  // NAVEGACIÓN
  // ===================================================================

  function irACasos() {
    const sheetUrl = document.getElementById('sheetUrlInput').value.trim();
    
    if (!sheetUrl) {
      mostrarToast('Por favor ingresa la URL de tu Google Sheet', 'warning');
      return;
    }
    
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          if (response.tieneConfig) {
            mostrarToast('Sheet verificado: ' + response.nombreSheet, 'success');
            mostrarPantallaCasos(sheetUrl);
          } else {
            mostrarToast('Sheet encontrado, necesita configuración', 'warning');
            mostrarPantallaSetup(sheetUrl, response);
          }
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error: ' + error.message, 'error');
      })
      .verificarConfiguracionSheet(sheetUrl);
  }

  function mostrarPantallaCasos(sheetUrl) {
    if (!sheetUrl || sheetUrl === '') {
      mostrarToast('Error: URL inválida', 'error');
      return;
    }
    
    guardarCurrentSheetUrl(sheetUrl);
    
    const inputUrl = document.getElementById('sheetUrlInput');
    if (inputUrl) {
      inputUrl.value = sheetUrl;
    }
    
    document.getElementById('welcomeScreen').classList.add('hidden');
    document.getElementById('casosScreen').classList.remove('hidden');
    
    cargarHojasDisponibles();
    cargarTodosLosCasos();
  }

  function volverAlDashboard() {
    document.getElementById('casosScreen').classList.add('hidden');
    document.getElementById('welcomeScreen').classList.remove('hidden');
  }

  // ===================================================================
  // CARGAR DATOS
  // ===================================================================

  function cargarHojasDisponibles() {
    const urlActual = recuperarSheetUrl();
    
    if (!urlActual) {
      mostrarToast('Error: No hay Sheet conectado', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          const selectHoja = document.getElementById('casoHoja');
          const selectFiltro = document.getElementById('filtroHoja');
          
          selectHoja.innerHTML = '<option value="">Usar hoja "Casos" (default)</option>';
          selectFiltro.innerHTML = '<option value="Todas">Todas las hojas</option>';
          
          selectFiltro.innerHTML += '<option value="Casos">Casos</option>';
          
          response.data.hojas.forEach(function(hoja) {
            selectHoja.innerHTML += '<option value="' + hoja + '">' + hoja + '</option>';
            selectFiltro.innerHTML += '<option value="' + hoja + '">' + hoja + '</option>';
          });
          
          selectHoja.innerHTML += '<option value="_nueva">➕ Crear nueva hoja</option>';
        }
      })
      .withFailureHandler(function(error) {
        mostrarToast('Error al cargar hojas: ' + error.message, 'error');
      })
      .obtenerHojasDisponibles(urlActual);
  }

  function toggleMostrarEliminados() {
    window.mostrarEliminados = document.getElementById('filtroMostrarEliminados').checked;
    cargarTodosLosCasos();
  }

  function cargarTodosLosCasos() {
    let urlActual = recuperarSheetUrl();
    
    if (!urlActual) {
      const inputUrl = document.getElementById('sheetUrlInput');
      if (inputUrl && inputUrl.value) {
        urlActual = inputUrl.value.trim();
        guardarCurrentSheetUrl(urlActual);
      }
    }
    
    if (!urlActual || urlActual === '') {
      const tbody = document.getElementById('tablaCasos');
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 2rem;">
            <div style="color: #ef4444; font-size: 1.1rem; margin-bottom: 0.5rem;">
              ❌ No hay Sheet conectado
            </div>
            <button onclick="volverAlDashboard()" class="btn btn-primary" style="margin-top: 1rem;">
              Volver al Inicio
            </button>
          </td>
        </tr>
      `;
      mostrarToast('Error: No hay Sheet conectado', 'error');
      return;
    }

    mostrarSpinner();

    const filtros = {
      excluirRegresiones: true,
      incluirEliminados: window.mostrarEliminados
    };

    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response === null || response === undefined) {
          const tbody = document.getElementById('tablaCasos');
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 2rem;">
                <div style="color: #ef4444;">⚠️ Error: El backend retornó null</div>
                <button onclick="cargarTodosLosCasos()" class="btn btn-primary" style="margin-top: 1rem;">
                  Reintentar
                </button>
              </td>
            </tr>
          `;
          mostrarToast('Error de comunicación con el backend', 'error');
          return;
        }
        
        if (response.success === false) {
          mostrarToast('Error: ' + response.mensaje, 'error');
          const tbody = document.getElementById('tablaCasos');
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 2rem; color: #ef4444;">
                ${response.mensaje || 'Error desconocido'}
              </td>
            </tr>
          `;
          return;
        }
        
        if (response.success === true) {
          window.casosActuales = (response.data && response.data.casos) ? response.data.casos : [];
          window.casosFiltrados = window.casosActuales;
          
          renderizarTablaCasos(window.casosActuales);
          
          if (window.casosActuales.length > 0) {
            mostrarToast('✅ Casos cargados: ' + window.casosActuales.length, 'success');
          } else {
            mostrarToast('No hay casos creados aún', 'info');
          }
          return;
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error: ' + error.message, 'error');
        
        const tbody = document.getElementById('tablaCasos');
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem;">
              <div style="color: #ef4444;">💥 Error Fatal</div>
              <div style="color: #64748b; margin-top: 0.5rem;">${error.message}</div>
              <button onclick="cargarTodosLosCasos()" class="btn btn-primary" style="margin-top: 1rem;">
                Reintentar
              </button>
            </td>
          </tr>
        `;
      })
      .listarCasos(urlActual, filtros);
  }

  function renderizarTablaCasos(casos) {
    const tbody = document.getElementById('tablaCasos');
    
    if (!casos || casos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #64748b;">No hay casos para mostrar</td></tr>';
      return;
    }

    let html = '';
    casos.forEach(function(caso) {
      const badgePrioridad = getBadgePrioridad(caso.Prioridad);
      const badgeEstado = getBadgeEstado(caso.Estado);
      const esCritico = caso.FlujoCritico === 'Si' || caso.FlujoCritico === 'Sí';
      const esRegresion = caso.CandidatoRegresion === 'Si' || caso.CandidatoRegresion === 'Sí';
      const esEliminado = caso.Estado === 'Eliminado';
      
      const clasesFila = esEliminado ? 'caso-eliminado' : '';
      
      html += '<tr class="' + clasesFila + '">';
      html += '<td style="font-family: monospace; font-weight: 600;">' + (caso.ID || '') + '</td>';
      html += '<td>' + (caso.Hoja || 'Casos') + '</td>';
      html += '<td>' + (caso.Titulo || '') + '</td>';
      html += '<td><span class="badge ' + badgePrioridad + '">' + (caso.Prioridad || '') + '</span></td>';
      html += '<td><span class="badge ' + badgeEstado + '">' + (caso.Estado || 'Pendiente') + '</span></td>';
      html += '<td class="indicador-critico">' + (esCritico ? '⭐' : '') + '</td>';
      html += '<td class="indicador-regresion">' + (esRegresion ? '🔄' : '') + '</td>';
      html += '<td>';
      
      if (esEliminado) {
        html += '<button class="btn btn-icon btn-success" onclick="restaurarCaso(\'' + caso.ID + '\')" title="Restaurar">';
        html += '↩️</button>';
      } else {
        html += '<button class="btn btn-icon btn-primary" onclick="verDetalleCaso(\'' + caso.ID + '\')" title="Ver detalle">';
        html += '👁️</button> ';
        html += '<button class="btn btn-icon btn-secondary" onclick="editarCaso(\'' + caso.ID + '\')" title="Editar">';
        html += '✏️</button> ';
        html += '<button class="btn btn-icon btn-danger" onclick="confirmarEliminarCaso(\'' + caso.ID + '\')" title="Eliminar">';
        html += '🗑️</button>';
      }
      
      html += '</td>';
      html += '</tr>';
    });
    
    tbody.innerHTML = html;
  }

  // ===================================================================
  // VER DETALLE
  // ===================================================================

  function verDetalleCaso(casoId) {
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          window.casoActualDetalle = response.data;
          mostrarModalDetalle(response.data);
        } else {
          mostrarToast('Error: ' + response.mensaje, 'error');
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error al obtener detalle: ' + error.message, 'error');
      })
      .obtenerDetalleCaso(recuperarSheetUrl(), casoId);
  }

  function mostrarModalDetalle(caso) {
    const esEliminado = caso.Estado === 'Eliminado';
    
    document.getElementById('detalleCasoIcono').textContent = esEliminado ? '👻' : '📋';
    document.getElementById('detalleCasoTitulo').textContent = caso.ID + ': ' + caso.Titulo;
    
    let html = '<div class="detalle-grid">';
    html += '<div class="detalle-label">🆔 ID:</div><div class="detalle-valor">' + (caso.ID || '-') + '</div>';
    html += '<div class="detalle-label">📂 Hoja/Módulo:</div><div class="detalle-valor">' + (caso.Hoja || 'Casos') + '</div>';
    html += '<div class="detalle-label">📋 Título:</div><div class="detalle-valor"><strong>' + (caso.Titulo || '-') + '</strong></div>';
    html += '<div class="detalle-label">📝 Descripción:</div><div class="detalle-valor">' + (caso.Descripcion || '-') + '</div>';
    html += '<div class="detalle-label">⚡ Prioridad:</div><div class="detalle-valor"><span class="badge ' + getBadgePrioridad(caso.Prioridad) + '">' + (caso.Prioridad || '-') + '</span></div>';
    html += '<div class="detalle-label">📊 Estado:</div><div class="detalle-valor"><span class="badge ' + getBadgeEstado(caso.Estado) + '">' + (caso.Estado || '-') + '</span></div>';
    html += '<div class="detalle-label">🔧 Formato:</div><div class="detalle-valor">' + (caso.Formato || '-') + '</div>';
    html += '<div class="detalle-label">🎯 Tipo de Prueba:</div><div class="detalle-valor">' + (caso.TipoPrueba || '-') + '</div>';
    html += '</div>';
    
    if (caso.Formato === 'Clasico') {
      html += '<div class="detalle-seccion">';
      html += '<div class="detalle-seccion-titulo">📝 Pasos</div>';
      html += '<div style="white-space: pre-wrap; background: #f8fafc; padding: 1rem; border-radius: 6px;">' + (caso.Pasos || 'No especificados') + '</div>';
      html += '</div>';
      
      html += '<div class="detalle-seccion">';
      html += '<div class="detalle-seccion-titulo">✅ Resultado Esperado</div>';
      html += '<div style="white-space: pre-wrap; background: #f8fafc; padding: 1rem; border-radius: 6px;">' + (caso.ResultadoEsperado || 'No especificado') + '</div>';
      html += '</div>';
    } else if (caso.Formato === 'Gherkin') {
      html += '<div class="detalle-seccion">';
      html += '<div class="detalle-seccion-titulo">🥒 Escenario Gherkin</div>';
      html += '<div style="white-space: pre-wrap; background: #f8fafc; padding: 1rem; border-radius: 6px;">';
      html += '<strong>Given:</strong> ' + (caso.ScenarioGiven || '-') + '<br>';
      html += '<strong>When:</strong> ' + (caso.ScenarioWhen || '-') + '<br>';
      html += '<strong>Then:</strong> ' + (caso.ScenarioThen || '-');
      html += '</div>';
      html += '</div>';
    }
    
    if (caso.Precondiciones) {
      html += '<div class="detalle-seccion">';
      html += '<div class="detalle-seccion-titulo">⚙️ Precondiciones</div>';
      html += '<div style="white-space: pre-wrap; background: #f8fafc; padding: 1rem; border-radius: 6px;">' + caso.Precondiciones + '</div>';
      html += '</div>';
    }
    
    html += '<div class="detalle-seccion">';
    html += '<div class="detalle-seccion-titulo">ℹ️ Información Adicional</div>';
    html += '<div class="detalle-grid">';
    html += '<div class="detalle-label">⭐ Flujo Crítico:</div><div class="detalle-valor">' + (caso.FlujoCritico === 'Si' || caso.FlujoCritico === 'Sí' ? '✅ Sí' : '❌ No') + '</div>';
    html += '<div class="detalle-label">🔄 Candidato Regresión:</div><div class="detalle-valor">' + (caso.CandidatoRegresion === 'Si' || caso.CandidatoRegresion === 'Sí' ? '✅ Sí' : '❌ No') + '</div>';
    html += '<div class="detalle-label">👤 Creado por:</div><div class="detalle-valor">' + (caso.CreadoPor || '-') + '</div>';
    html += '<div class="detalle-label">📅 Fecha creación:</div><div class="detalle-valor">' + (caso.FechaCreacion ? formatearFecha(caso.FechaCreacion) : '-') + '</div>';
    html += '<div class="detalle-label">🔗 URI:</div><div class="detalle-valor" style="font-family: monospace; font-size: 0.85rem;">' + (caso.CasoURI || '-') + '</div>';
    html += '</div>';
    html += '</div>';
    
    if (caso.Notas) {
      html += '<div class="detalle-seccion">';
      html += '<div class="detalle-seccion-titulo">📌 Notas</div>';
      html += '<div style="white-space: pre-wrap; background: #fef3c7; padding: 1rem; border-radius: 6px;">' + caso.Notas + '</div>';
      html += '</div>';
    }
    
    document.getElementById('detalleCasoContenido').innerHTML = html;
    
    if (esEliminado) {
      document.getElementById('btnEditarCasoDetalle').classList.add('hidden');
      document.getElementById('btnEliminarCasoDetalle').classList.add('hidden');
      document.getElementById('btnRestaurarCasoDetalle').classList.remove('hidden');
    } else {
      document.getElementById('btnEditarCasoDetalle').classList.remove('hidden');
      document.getElementById('btnEliminarCasoDetalle').classList.remove('hidden');
      document.getElementById('btnRestaurarCasoDetalle').classList.add('hidden');
    }
    
    abrirModal('modalDetalleCaso');
  }

  // ===================================================================
  // EDITAR
  // ===================================================================

  function editarCaso(casoId) {
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          cargarCasoEnFormulario(response.data);
        } else {
          mostrarToast('Error: ' + response.mensaje, 'error');
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error al obtener caso: ' + error.message, 'error');
      })
      .obtenerDetalleCaso(recuperarSheetUrl(), casoId);
  }

  function editarCasoDesdeDetalle() {
    if (window.casoActualDetalle) {
      cerrarModal('modalDetalleCaso');
      cargarCasoEnFormulario(window.casoActualDetalle);
    }
  }

  function cargarCasoEnFormulario(caso) {
  console.log('📝 Cargando caso en formulario:', caso);
  
  // PRIMERO: Abrir el modal SIN resetear
  const modal = document.getElementById('modalCrearCaso');
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // SEGUNDO: Cambiar título del modal
  document.getElementById('tituloModalCaso').textContent = '✏️ Editar Caso: ' + caso.ID;
  
  // TERCERO: Guardar datos de edición
  document.getElementById('casoIdEdicion').value = caso.ID;
  
  // CRÍTICO: Guardar hoja original (usar "Casos" si no tiene)
  const hojaOriginal = caso.Hoja || 'Casos';
  document.getElementById('casoHojaOriginal').value = hojaOriginal;
  
  console.log('📂 Hoja original del caso:', hojaOriginal);
  
  // CUARTO: Esperar a que el DOM esté listo y llenar campos
  setTimeout(() => {
    try {
      // ═══════════════════════════════════════════════════════════
      // FIX 1: Asegurar que el select tenga la opción correcta
      // ═══════════════════════════════════════════════════════════
      const selectHoja = document.getElementById('casoHoja');
      if (selectHoja) {
        // Buscar si la hoja existe en el select
        let hojaEncontrada = false;
        
        for (let i = 0; i < selectHoja.options.length; i++) {
          if (selectHoja.options[i].value === hojaOriginal) {
            hojaEncontrada = true;
            break;
          }
        }
        
        // Si la hoja no está en el select, agregarla temporalmente
        if (!hojaEncontrada && hojaOriginal !== '') {
          const option = document.createElement('option');
          option.value = hojaOriginal;
          option.textContent = hojaOriginal;
          selectHoja.insertBefore(option, selectHoja.options[1]); // Insertar después de "Casos (default)"
          console.log('➕ Hoja agregada al select:', hojaOriginal);
        }
        
        // Ahora sí seleccionar la hoja
        if (hojaOriginal === 'Casos' || hojaOriginal === '') {
          selectHoja.value = ''; // Opción "Usar hoja Casos (default)"
        } else {
          selectHoja.value = hojaOriginal;
        }
        
        console.log('✅ Hoja seleccionada en desplegable:', selectHoja.value || 'Casos (default)');
      }
      
      // Formato
      const selectFormato = document.getElementById('casoFormato');
      if (selectFormato) {
        selectFormato.value = caso.Formato || 'Clasico';
      }
      
      // Campos de texto
      document.getElementById('casoTitulo').value = caso.Titulo || '';
      document.getElementById('casoDescripcion').value = caso.Descripcion || '';
      
      // Selects
      const selectPrioridad = document.getElementById('casoPrioridad');
      if (selectPrioridad) {
        selectPrioridad.value = caso.Prioridad || 'Media';
      }
      
      const selectTipo = document.getElementById('casoTipoPrueba');
      if (selectTipo) {
        selectTipo.value = caso.TipoPrueba || 'Funcional';
      }
      
      // Campos según formato
      if (caso.Formato === 'Clasico') {
        document.getElementById('casoPasos').value = caso.Pasos || '';
        document.getElementById('casoResultadoEsperado').value = caso.ResultadoEsperado || '';
      } else if (caso.Formato === 'Gherkin') {
        document.getElementById('casoGiven').value = caso.ScenarioGiven || '';
        document.getElementById('casoWhen').value = caso.ScenarioWhen || '';
        document.getElementById('casoThen').value = caso.ScenarioThen || '';
      }
      
      // Precondiciones
      document.getElementById('casoPrecondiciones').value = caso.Precondiciones || '';
      
      // Checkboxes
      document.getElementById('casoFlujoCritico').checked = (caso.FlujoCritico === 'Si' || caso.FlujoCritico === 'Sí');
      document.getElementById('casoCandidatoRegresion').checked = (caso.CandidatoRegresion === 'Si' || caso.CandidatoRegresion === 'Sí');
      
      // Mostrar campos según formato
      cambiarFormatoCaso();
      
      // Marcar que NO hay cambios al inicio
      window.formularioTieneCambios = false;
      
      // Configurar listeners de cambios
      const inputs = document.querySelectorAll('#formCrearCaso input, #formCrearCaso textarea, #formCrearCaso select');
      inputs.forEach(input => {
        input.removeEventListener('change', marcarCambios);
        input.removeEventListener('input', marcarCambios);
        input.addEventListener('change', marcarCambios);
        input.addEventListener('input', marcarCambios);
      });
      
      console.log('✅ Formulario cargado completamente');
      
    } catch (error) {
      console.error('❌ Error llenando formulario:', error);
      mostrarToast('Error al cargar datos del caso', 'error');
    }
  }, 150); // Aumentado a 150ms para asegurar que el DOM esté listo
}

  function marcarCambios() {
    window.formularioTieneCambios = true;
  }

  // ===================================================================
  // ELIMINAR Y RESTAURAR
  // ===================================================================

  async function confirmarEliminarCaso(casoId) {
    const confirmar = await mostrarConfirmacionApp({
      titulo: 'Eliminar Caso',
      mensaje: '¿Estás seguro de eliminar este caso?<br><br><strong>' + casoId + '</strong><br><br>⚠️ El caso se marcará como eliminado pero no se borrará permanentemente.',
      icono: '🗑️',
      textoOk: 'Sí, Eliminar',
      textoCancelar: 'Cancelar'
    });
    
    if (!confirmar) return;
    
    eliminarCaso(casoId);
  }

  function eliminarCaso(casoId) {
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          mostrarToast('✅ Caso eliminado correctamente', 'success');
          cargarTodosLosCasos();
        } else {
          mostrarToast('Error: ' + response.mensaje, 'error');
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error al eliminar: ' + error.message, 'error');
      })
      .eliminarCaso(recuperarSheetUrl(), casoId);
  }

  function eliminarCasoDesdeDetalle() {
    if (window.casoActualDetalle) {
      cerrarModal('modalDetalleCaso');
      confirmarEliminarCaso(window.casoActualDetalle.ID);
    }
  }

  async function restaurarCaso(casoId) {
    const confirmar = await mostrarConfirmacionApp({
      titulo: 'Restaurar Caso',
      mensaje: '¿Deseas restaurar este caso?<br><br><strong>' + casoId + '</strong><br><br>El caso volverá a estar disponible con estado "Pendiente".',
      icono: '↩️',
      textoOk: 'Sí, Restaurar',
      textoCancelar: 'Cancelar'
    });
    
    if (!confirmar) return;
    
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          mostrarToast('✅ Caso restaurado correctamente', 'success');
          cargarTodosLosCasos();
        } else {
          mostrarToast('Error: ' + response.mensaje, 'error');
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error al restaurar: ' + error.message, 'error');
      })
      .restaurarCaso(recuperarSheetUrl(), casoId);
  }

  function restaurarCasoDesdeDetalle() {
    if (window.casoActualDetalle) {
      cerrarModal('modalDetalleCaso');
      restaurarCaso(window.casoActualDetalle.ID);
    }
  }

  // ===================================================================
  // MODAL CREAR/EDITAR - PARTE 1
  // ===================================================================

  function abrirModalCrearCaso() {
    console.log('➕ Abriendo modal para crear nuevo caso');
    
    document.getElementById('tituloModalCaso').textContent = '➕ Nuevo Caso de Prueba';
    document.getElementById('casoIdEdicion').value = '';
    document.getElementById('casoHojaOriginal').value = '';
    
    abrirModal('modalCrearCaso');
    
    document.getElementById('formCrearCaso').reset();
    
    cambiarFormatoCaso();
    
    window.formularioTieneCambios = false;
    
    const inputs = document.querySelectorAll('#formCrearCaso input, #formCrearCaso textarea, #formCrearCaso select');
    inputs.forEach(input => {
      input.removeEventListener('change', marcarCambios);
      input.removeEventListener('input', marcarCambios);
      input.addEventListener('change', marcarCambios);
      input.addEventListener('input', marcarCambios);
    });
  }

  async function cerrarModalCaso() {
  if (window.formularioTieneCambios) {
    const confirmar = await mostrarConfirmacionApp({
      titulo: 'Cambios sin guardar',
      mensaje: 'Tienes cambios sin guardar.<br><br>¿Deseas descartar los cambios y cerrar?',
      icono: '⚠️',
      textoOk: 'Descartar cambios',
      textoCancelar: 'Seguir editando'
    });
    
    if (confirmar) {
      // Usuario eligió "Descartar cambios"
      cerrarModal('modalCrearCaso');
      window.formularioTieneCambios = false;
      document.getElementById('formCrearCaso').reset();
      document.getElementById('casoIdEdicion').value = '';
      document.getElementById('casoHojaOriginal').value = '';
      document.getElementById('tituloModalCaso').textContent = '➕ Nuevo Caso de Prueba';
    }
    // Si confirmar === false (usuario eligió "Seguir editando"), NO hacer nada
    // El modal permanece abierto
  } else {
    // No hay cambios, cerrar directamente
    cerrarModal('modalCrearCaso');
    document.getElementById('formCrearCaso').reset();
    document.getElementById('casoIdEdicion').value = '';
    document.getElementById('casoHojaOriginal').value = '';
    document.getElementById('tituloModalCaso').textContent = '➕ Nuevo Caso de Prueba';
  }
}

  function cambiarFormatoCaso() {
    const formato = document.getElementById('casoFormato').value;
    const camposClasico = document.getElementById('camposClasico');
    const camposGherkin = document.getElementById('camposGherkin');
    
    if (formato === 'Gherkin') {
      camposClasico.classList.add('hidden');
      camposGherkin.classList.remove('hidden');
    } else {
      camposClasico.classList.remove('hidden');
      camposGherkin.classList.add('hidden');
    }
  }

  function manejarCambioHoja() {
    const selectHoja = document.getElementById('casoHoja');
    const advertencia = document.getElementById('advertenciaHoja');
    
    if (selectHoja.value === '_nueva') {
      abrirModalCrearHoja();
      advertencia.classList.add('hidden');
    } else if (selectHoja.value === '') {
      advertencia.classList.remove('hidden');
    } else {
      advertencia.classList.add('hidden');
    }
  }
// ===================================================================
  // GUARDAR CASO - CON LÓGICA DE MOVER
  // ===================================================================

  async function guardarCaso() {
    const formato = document.getElementById('casoFormato').value;
    const hojaSeleccionada = document.getElementById('casoHoja').value;
    const urlActual = recuperarSheetUrl();
    const casoIdEdicion = document.getElementById('casoIdEdicion').value;
    const hojaOriginal = document.getElementById('casoHojaOriginal').value;
    const modoEdicion = casoIdEdicion !== '';
    
    console.log('💾 Guardando caso - Modo:', modoEdicion ? 'EDICIÓN' : 'CREAR');
    console.log('  Hoja seleccionada:', hojaSeleccionada || 'Casos');
    console.log('  Hoja original:', hojaOriginal);
    
    if (!urlActual) {
      mostrarToast('Error: No hay Sheet conectado', 'error');
      return;
    }
    
    // Validar si no hay hoja seleccionada en modo crear
    if (!hojaSeleccionada && !modoEdicion) {
      const confirmar = await mostrarConfirmacionApp({
        titulo: 'Hoja no seleccionada',
        mensaje: 'El caso se guardará en la hoja <strong>"Casos"</strong> por defecto.<br><br>¿Deseas continuar?',
        icono: '📋',
        textoOk: 'Guardar en "Casos"',
        textoCancelar: 'Seleccionar hoja'
      });
      
      if (!confirmar) return;
    }
    
    if (modoEdicion) {
      // ═══════════════════════════════════════════════════════════
      // MODO EDICIÓN
      // ═══════════════════════════════════════════════════════════
      
      const hojaFinal = hojaSeleccionada || 'Casos';
      const cambioDeHoja = hojaFinal !== hojaOriginal;
      
      console.log('🔍 Detectando cambio de hoja:', cambioDeHoja);
      
      if (cambioDeHoja) {
        // NUEVO: Se cambió la hoja → MOVER caso
        console.log('📦 Se detectó cambio de hoja, iniciando proceso de mover...');
        
        const confirmar = await mostrarConfirmacionApp({
          titulo: 'Mover Caso',
          mensaje: '⚠️ <strong>Estás cambiando la hoja de este caso</strong><br><br>' +
                   'De: <strong>"' + hojaOriginal + '"</strong><br>' +
                   'A: <strong>"' + hojaFinal + '"</strong><br><br>' +
                   'El caso desaparecerá de "' + hojaOriginal + '" y aparecerá en "' + hojaFinal + '".<br><br>' +
                   'El ID <strong>' + casoIdEdicion + '</strong> se mantendrá igual.<br><br>' +
                   '¿Continuar?',
          icono: '📦',
          textoOk: 'Sí, Mover Caso',
          textoCancelar: 'Cancelar'
        });
        
        if (!confirmar) {
          console.log('❌ Usuario canceló el movimiento');
          return;
        }
        
        // Primero MOVER el caso
        console.log('📦 Moviendo caso ' + casoIdEdicion + ' a hoja: ' + hojaFinal);
        mostrarSpinner();
        
        google.script.run
          .withSuccessHandler(function(responseMover) {
            console.log('📦 Respuesta de moverCaso:', responseMover);
            
            if (responseMover.success) {
              console.log('✅ Caso movido exitosamente, ahora actualizando campos...');
              
              // LUEGO actualizar los demás campos en la nueva ubicación
              const datosActualizados = construirDatosActualizados(formato, hojaFinal);
              
              google.script.run
                .withSuccessHandler(function(responseActualizar) {
                  ocultarSpinner();
                  
                  if (responseActualizar.success) {
                    mostrarToast('✅ Caso movido y actualizado exitosamente', 'success');
                    window.formularioTieneCambios = false;
                    cerrarModal('modalCrearCaso');
                    cargarTodosLosCasos();
                  } else {
                    mostrarToast('⚠️ Caso movido pero no se pudieron actualizar todos los campos: ' + responseActualizar.mensaje, 'warning');
                    cargarTodosLosCasos();
                  }
                })
                .withFailureHandler(function(error) {
                  ocultarSpinner();
                  mostrarToast('⚠️ Caso movido pero error al actualizar: ' + error.message, 'warning');
                  cargarTodosLosCasos();
                })
                .actualizarCaso(urlActual, casoIdEdicion, datosActualizados);
              
            } else {
              ocultarSpinner();
              mostrarToast('Error al mover: ' + responseMover.mensaje, 'error');
            }
          })
          .withFailureHandler(function(error) {
            ocultarSpinner();
            console.error('💥 Error al mover caso:', error);
            mostrarToast('Error al mover caso: ' + error.message, 'error');
          })
          .moverCaso(urlActual, casoIdEdicion, hojaFinal);
        
      } else {
        // NO cambió de hoja → ACTUALIZACIÓN NORMAL
        console.log('✏️ Actualización normal (sin mover)');
        
        const datosActualizados = construirDatosActualizados(formato, hojaFinal);
        
        mostrarSpinner();
        
        google.script.run
          .withSuccessHandler(function(response) {
            ocultarSpinner();
            
            if (response.success) {
              mostrarToast('✅ Caso actualizado exitosamente', 'success');
              window.formularioTieneCambios = false;
              cerrarModal('modalCrearCaso');
              cargarTodosLosCasos();
            } else {
              mostrarToast('Error: ' + response.mensaje, 'error');
            }
          })
          .withFailureHandler(function(error) {
            ocultarSpinner();
            mostrarToast('Error al actualizar: ' + error.message, 'error');
          })
          .actualizarCaso(urlActual, casoIdEdicion, datosActualizados);
      }
      
    } else {
      // ═══════════════════════════════════════════════════════════
      // MODO CREAR
      // ═══════════════════════════════════════════════════════════
      
      const hojaFinal = hojaSeleccionada || 'Casos';
      
      const datosCaso = {
        sheetUrl: urlActual,
        hoja: hojaFinal,
        titulo: document.getElementById('casoTitulo').value,
        descripcion: document.getElementById('casoDescripcion').value,
        prioridad: document.getElementById('casoPrioridad').value,
        tipoPrueba: document.getElementById('casoTipoPrueba').value,
        formatoCaso: formato,
        flujoCritico: document.getElementById('casoFlujoCritico').checked,
        candidatoRegresion: document.getElementById('casoCandidatoRegresion').checked,
        precondiciones: document.getElementById('casoPrecondiciones').value
      };

      if (formato === 'Clasico') {
        datosCaso.pasos = document.getElementById('casoPasos').value;
        datosCaso.resultadoEsperado = document.getElementById('casoResultadoEsperado').value;
      } else {
        datosCaso.scenarioGiven = document.getElementById('casoGiven').value;
        datosCaso.scenarioWhen = document.getElementById('casoWhen').value;
        datosCaso.scenarioThen = document.getElementById('casoThen').value;
      }

      mostrarSpinner();

      google.script.run
        .withSuccessHandler(function(response) {
          ocultarSpinner();
          
          if (response.success) {
            const hojaUsada = response.data.hoja || 'Casos';
            const idCaso = response.data.idCaso || 'TC-X';
            const mensaje = '✅ Caso ' + idCaso + ' creado exitosamente en hoja "' + hojaUsada + '"';
            mostrarToast(mensaje, 'success');
            
            window.formularioTieneCambios = false;
            cerrarModal('modalCrearCaso');
            cargarTodosLosCasos();
          } else {
            mostrarToast('Error: ' + response.mensaje, 'error');
          }
        })
        .withFailureHandler(function(error) {
          ocultarSpinner();
          mostrarToast('Error al crear caso: ' + error.message, 'error');
        })
        .crearCaso(datosCaso);
    }
  }

  /**
   * Construye objeto con datos actualizados
   */
  function construirDatosActualizados(formato, hojaFinal) {
    const datosActualizados = {
      Hoja: hojaFinal,
      Formato: formato,
      Titulo: document.getElementById('casoTitulo').value,
      Descripcion: document.getElementById('casoDescripcion').value,
      Prioridad: document.getElementById('casoPrioridad').value,
      TipoPrueba: document.getElementById('casoTipoPrueba').value,
      Precondiciones: document.getElementById('casoPrecondiciones').value,
      FlujoCritico: document.getElementById('casoFlujoCritico').checked ? 'Si' : 'No',
      CandidatoRegresion: document.getElementById('casoCandidatoRegresion').checked ? 'Si' : 'No'
    };
    
    if (formato === 'Clasico') {
      datosActualizados.Pasos = document.getElementById('casoPasos').value;
      datosActualizados.ResultadoEsperado = document.getElementById('casoResultadoEsperado').value;
      datosActualizados.ScenarioGiven = '';
      datosActualizados.ScenarioWhen = '';
      datosActualizados.ScenarioThen = '';
    } else {
      datosActualizados.ScenarioGiven = document.getElementById('casoGiven').value;
      datosActualizados.ScenarioWhen = document.getElementById('casoWhen').value;
      datosActualizados.ScenarioThen = document.getElementById('casoThen').value;
      datosActualizados.Pasos = '';
      datosActualizados.ResultadoEsperado = '';
    }
    
    return datosActualizados;
  }

  // ===================================================================
  // MODAL CREAR NUEVA HOJA
  // ===================================================================

  function abrirModalCrearHoja() {
    cerrarModal('modalCrearCaso');
    abrirModal('modalCrearHoja');
    document.getElementById('nombreNuevaHoja').value = '';
    document.getElementById('nombreNuevaHoja').focus();
    cargarHojasExistentesEnModal();
  }

  function cerrarModalCrearHoja() {
    cerrarModal('modalCrearHoja');
    abrirModal('modalCrearCaso');
    
    const selectHoja = document.getElementById('casoHoja');
    if (selectHoja.value === '_nueva') {
      selectHoja.value = '';
    }
    
    document.getElementById('advertenciaNombreHoja').classList.add('hidden');
  }

  function cargarHojasExistentesEnModal() {
    const listaDiv = document.getElementById('listaHojasExistentes');
    const urlActual = recuperarSheetUrl();
    
    if (!urlActual) {
      listaDiv.innerHTML = '<em style="color: #ef4444;">Error: No hay Sheet conectado</em>';
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          window.hojasExistentesGlobal = response.data.hojas;
          
          if (window.hojasExistentesGlobal.length === 0) {
            listaDiv.innerHTML = '<em style="color: #94a3b8;">No hay hojas creadas aún</em>';
          } else {
            listaDiv.innerHTML = window.hojasExistentesGlobal.map(function(hoja) {
              return '<span style="display: inline-block; background: white; padding: 0.25rem 0.75rem; border-radius: 6px; margin: 0.25rem; border: 1px solid #e2e8f0;">' + hoja + '</span>';
            }).join('');
          }
        }
      })
      .withFailureHandler(function(error) {
        listaDiv.innerHTML = '<em style="color: #ef4444;">Error al cargar hojas</em>';
      })
      .obtenerHojasDisponibles(urlActual);
  }

  function validarNombreHoja() {
    const nombreInput = document.getElementById('nombreNuevaHoja').value.trim();
    const advertenciaDiv = document.getElementById('advertenciaNombreHoja');
    const mensajeP = document.getElementById('mensajeNombreSimilar');
    const btnCrear = document.getElementById('btnCrearHoja');
    
    if (!nombreInput || window.hojasExistentesGlobal.length === 0) {
      advertenciaDiv.classList.add('hidden');
      btnCrear.disabled = false;
      return;
    }
    
    const nombreNormalizado = nombreInput.toLowerCase().trim();
    let hojasSimilares = [];
    
    window.hojasExistentesGlobal.forEach(function(hojaExistente) {
      const existenteNormalizado = hojaExistente.toLowerCase().trim();
      
      if (existenteNormalizado === nombreNormalizado) {
        hojasSimilares.push({ nombre: hojaExistente, tipo: 'exacta' });
      } else if (existenteNormalizado.indexOf(nombreNormalizado) > -1 || 
                 nombreNormalizado.indexOf(existenteNormalizado) > -1) {
        hojasSimilares.push({ nombre: hojaExistente, tipo: 'parcial' });
      }
    });
    
    if (hojasSimilares.length > 0) {
      const primera = hojasSimilares[0];
      
      if (primera.tipo === 'exacta') {
        mensajeP.innerHTML = 'Ya existe una hoja llamada "<strong>' + primera.nombre + '</strong>". Por favor usa otro nombre.';
        advertenciaDiv.style.background = '#fee2e2';
        advertenciaDiv.style.borderLeftColor = '#ef4444';
        btnCrear.disabled = true;
      } else {
        mensajeP.innerHTML = 'Ya existe una hoja similar: "<strong>' + primera.nombre + '</strong>". ¿Estás seguro de crear "' + nombreInput + '"?';
        advertenciaDiv.classList.remove('hidden');
        btnCrear.disabled = false;
      }
      
      advertenciaDiv.classList.remove('hidden');
    } else {
      advertenciaDiv.classList.add('hidden');
      btnCrear.disabled = false;
    }
  }

  function crearHojaNueva() {
    const nombreHoja = document.getElementById('nombreNuevaHoja').value.trim();
    const urlActual = recuperarSheetUrl();
    
    if (!urlActual) {
      mostrarToast('Error: No hay Sheet conectado', 'error');
      return;
    }
    
    if (!nombreHoja) {
      mostrarToast('Ingresa un nombre para la hoja', 'warning');
      return;
    }
    
    const btnCrear = document.getElementById('btnCrearHoja');
    if (btnCrear.disabled) {
      mostrarToast('Este nombre ya existe. Usa otro nombre.', 'error');
      return;
    }
    
    mostrarSpinner();
    
    google.script.run
      .withSuccessHandler(function(response) {
        ocultarSpinner();
        
        if (response.success) {
          mostrarToast('✅ Hoja creada: ' + nombreHoja, 'success');
          cerrarModalCrearHoja();
          cargarHojasDisponibles();
          
          setTimeout(function() {
            const selectHoja = document.getElementById('casoHoja');
            selectHoja.value = nombreHoja;
          }, 500);
          
        } else {
          mostrarToast('Error: ' + response.mensaje, 'error');
        }
      })
      .withFailureHandler(function(error) {
        ocultarSpinner();
        mostrarToast('Error al crear hoja: ' + error.message, 'error');
      })
      .crearNuevaHoja(urlActual, nombreHoja);
  }

  // ===================================================================
  // FILTROS
  // ===================================================================

  function aplicarFiltrosEnTiempoReal() {
    const busqueda = document.getElementById('filtroBusqueda').value.toLowerCase();
    const hoja = document.getElementById('filtroHoja').value;
    const prioridad = document.getElementById('filtroPrioridad').value;
    const estado = document.getElementById('filtroEstado').value;
    const soloFlujoCritico = document.getElementById('filtroFlujoCritico').checked;
    const soloCandidatosRegresion = document.getElementById('filtroCandidatosRegresion').checked;

    window.casosFiltrados = window.casosActuales.filter(function(caso) {
      if (busqueda && busqueda !== '') {
        const titulo = (caso.Titulo || '').toLowerCase();
        const descripcion = (caso.Descripcion || '').toLowerCase();
        if (!titulo.includes(busqueda) && !descripcion.includes(busqueda)) {
          return false;
        }
      }
      
      if (hoja && hoja !== 'Todas') {
        if ((caso.Hoja || 'Casos') !== hoja) {
          return false;
        }
      }
      
      if (prioridad && prioridad !== 'Todas') {
        if (caso.Prioridad !== prioridad) {
          return false;
        }
      }
      
      if (estado && estado !== 'Todos') {
        if (caso.Estado !== estado) {
          return false;
        }
      }
      
      if (soloFlujoCritico && caso.FlujoCritico !== 'Si' && caso.FlujoCritico !== 'Sí') {
        return false;
      }
      
      if (soloCandidatosRegresion && caso.CandidatoRegresion !== 'Si' && caso.CandidatoRegresion !== 'Sí') {
        return false;
      }
      
      return true;
    });

    renderizarTablaCasos(window.casosFiltrados); }  

  console.log('✅ Frontend Components Casos v3.0 COMPLETO cargado');
</script>
