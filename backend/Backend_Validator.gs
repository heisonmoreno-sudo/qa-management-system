/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * BACKEND_VALIDATOR.GS
 * Sistema de validaci√≥n de integridad del proyecto QA Management System
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

/**
 * Funci√≥n principal - Ejecuta todas las validaciones
 * EJECUTAR ESTA despu√©s de cada actualizaci√≥n de c√≥digo
 */
function validarSistemaCompleto() {
  const resultado = {
    timestamp: new Date(),
    errores: [],
    advertencias: [],
    info: [],
    resumen: {}
  };

  Logger.log('üîç Iniciando validaci√≥n del sistema...\n');
  
  try {
    // 1. Validar estructura de archivos Backend
    validarArchivosBackend(resultado);
    
    // 2. Validar funciones referenciadas
    validarReferenciasBackend(resultado);
    
    // 3. Validar configuraci√≥n del Sheet
    validarConfiguracionSheet(resultado);
    
    // 4. Validar estructura Frontend (b√°sico)
    validarEstructuraFrontend(resultado);
    
    // 5. Generar reporte
    generarReporte(resultado);
    
  } catch (error) {
    Logger.log('‚ùå ERROR CR√çTICO EN VALIDACI√ìN: ' + error.message);
    Logger.log(error.stack);
  }
  
  return resultado;
}

/**
 * Valida que existan los archivos Backend principales
 */
function validarArchivosBackend(resultado) {
  Logger.log('üìÅ Validando archivos Backend...');
  
  const archivosRequeridos = [
    'doGet',
    'obtenerConfiguracion',
    'guardarConfiguracion'
  ];
  
  archivosRequeridos.forEach(func => {
    if (typeof this[func] === 'function') {
      resultado.info.push(`‚úÖ Funci√≥n core encontrada: ${func}`);
    } else {
      resultado.errores.push(`‚ùå Funci√≥n core NO encontrada: ${func}`);
    }
  });
}

/**
 * Valida referencias entre funciones Backend
 */
function validarReferenciasBackend(resultado) {
  Logger.log('üîó Validando referencias entre funciones...');
  
  // Definir mapeo de funciones esperadas por m√≥dulo
  const funcionesEsperadas = {
    'Casos': [
      'obtenerCasosPorHoja',
      'crearNuevoCaso',
      'actualizarCaso',
      'eliminarCaso',
      'obtenerHojasDisponibles'
    ],
    'Bugs': [
      'obtenerBugs',
      'crearBug',
      'sincronizarBugsConTrello'
    ],
    'Workspace': [
      'obtenerWorkspaces',
      'guardarWorkspace',
      'seleccionarWorkspace'
    ],
    'Trello': [
      'validarConexionTrello',
      'obtenerTablerosTrello'
    ]
  };
  
  // Validar cada m√≥dulo
  Object.keys(funcionesEsperadas).forEach(modulo => {
    const funciones = funcionesEsperadas[modulo];
    let encontradas = 0;
    
    funciones.forEach(func => {
      if (typeof this[func] === 'function') {
        encontradas++;
      } else {
        resultado.advertencias.push(`‚ö†Ô∏è  ${modulo}: Funci√≥n '${func}' no encontrada`);
      }
    });
    
    if (encontradas === funciones.length) {
      resultado.info.push(`‚úÖ M√≥dulo ${modulo}: ${encontradas}/${funciones.length} funciones OK`);
    } else {
      resultado.advertencias.push(`‚ö†Ô∏è  M√≥dulo ${modulo}: Solo ${encontradas}/${funciones.length} funciones encontradas`);
    }
  });
}

/**
 * Valida la configuraci√≥n del Google Sheet
 */
function validarConfiguracionSheet(resultado) {
  Logger.log('üìä Validando configuraci√≥n del Sheet...');
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (!ss) {
      resultado.errores.push('‚ùå No se puede acceder al Spreadsheet activo');
      return;
    }
    
    resultado.info.push(`‚úÖ Spreadsheet activo: ${ss.getName()}`);
    
    // Verificar hoja Config
    const configSheet = ss.getSheetByName('Config');
    if (configSheet) {
      resultado.info.push('‚úÖ Hoja "Config" encontrada');
      
      // Verificar estructura b√°sica
      const headers = configSheet.getRange(1, 1, 1, 3).getValues()[0];
      if (headers[0] === 'Clave' && headers[1] === 'Valor') {
        resultado.info.push('‚úÖ Estructura de Config correcta');
      } else {
        resultado.advertencias.push('‚ö†Ô∏è  Estructura de Config no est√°ndar');
      }
    } else {
      resultado.errores.push('‚ùå Hoja "Config" NO encontrada - Sistema no funcionar√°');
    }
    
    // Verificar hoja Bugs
    const bugsSheet = ss.getSheetByName('Bugs');
    if (bugsSheet) {
      resultado.info.push('‚úÖ Hoja "Bugs" encontrada');
    } else {
      resultado.advertencias.push('‚ö†Ô∏è  Hoja "Bugs" no encontrada - Funcionalidad limitada');
    }
    
    // Contar hojas de casos (excluyendo Config y Bugs)
    const allSheets = ss.getSheets();
    const hojasCase = allSheets.filter(s => 
      s.getName() !== 'Config' && 
      s.getName() !== 'Bugs'
    );
    
    if (hojasCase.length > 0) {
      resultado.info.push(`‚úÖ ${hojasCase.length} hoja(s) de casos encontradas: ${hojasCase.map(s => s.getName()).join(', ')}`);
    } else {
      resultado.advertencias.push('‚ö†Ô∏è  No se encontraron hojas de casos de prueba');
    }
    
  } catch (error) {
    resultado.advertencias.push(`‚ö†Ô∏è  No se puede validar Sheet (puede estar ejecut√°ndose desde editor): ${error.message}`);
  }
}

/**
 * Valida estructura b√°sica del Frontend
 */
function validarEstructuraFrontend(resultado) {
  Logger.log('üé® Validando estructura Frontend...');
  
  try {
    // Intentar obtener el HTML
    const html = HtmlService.createTemplateFromFile('Frontend_Index');
    if (html) {
      resultado.info.push('‚úÖ Frontend_Index.html encontrado');
    }
  } catch (error) {
    resultado.errores.push('‚ùå Frontend_Index.html NO encontrado o tiene errores');
  }
  
  // Lista de componentes esperados
  const componentesEsperados = [
    'Frontend_Styles_Base',
    'Frontend_Scripts_Main',
    'Frontend_Components_Casos'
  ];
  
  componentesEsperados.forEach(comp => {
    try {
      HtmlService.createTemplateFromFile(comp);
      resultado.info.push(`‚úÖ Componente encontrado: ${comp}.html`);
    } catch (error) {
      resultado.advertencias.push(`‚ö†Ô∏è  Componente no encontrado: ${comp}.html`);
    }
  });
}

/**
 * Genera y muestra el reporte final
 */
function generarReporte(resultado) {
  Logger.log('\n' + '‚ïê'.repeat(70));
  Logger.log('üìã REPORTE DE VALIDACI√ìN DEL SISTEMA');
  Logger.log('‚ïê'.repeat(70));
  Logger.log(`üïê Timestamp: ${resultado.timestamp.toLocaleString()}`);
  Logger.log('');
  
  // Resumen
  Logger.log('üìä RESUMEN:');
  Logger.log(`   ‚úÖ Info: ${resultado.info.length} items`);
  Logger.log(`   ‚ö†Ô∏è  Advertencias: ${resultado.advertencias.length} items`);
  Logger.log(`   ‚ùå Errores: ${resultado.errores.length} items`);
  Logger.log('');
  
  // Errores cr√≠ticos
  if (resultado.errores.length > 0) {
    Logger.log('‚ùå ERRORES CR√çTICOS (REQUIEREN ATENCI√ìN):');
    resultado.errores.forEach(err => Logger.log(`   ${err}`));
    Logger.log('');
  }
  
  // Advertencias
  if (resultado.advertencias.length > 0) {
    Logger.log('‚ö†Ô∏è  ADVERTENCIAS (REVISAR):');
    resultado.advertencias.forEach(adv => Logger.log(`   ${adv}`));
    Logger.log('');
  }
  
  // Info
  if (resultado.info.length > 0) {
    Logger.log('‚úÖ VALIDACIONES EXITOSAS:');
    resultado.info.forEach(info => Logger.log(`   ${info}`));
    Logger.log('');
  }
  
  // Conclusi√≥n
  Logger.log('‚ïê'.repeat(70));
  if (resultado.errores.length === 0) {
    Logger.log('‚úÖ SISTEMA VALIDADO CORRECTAMENTE');
  } else {
    Logger.log('‚ùå SISTEMA CON ERRORES - REVISAR ARRIBA');
  }
  Logger.log('‚ïê'.repeat(70));
  
  // Mensaje para el usuario (solo si se ejecuta desde Sheet)
  try {
    const ui = SpreadsheetApp.getUi();
    if (resultado.errores.length === 0 && resultado.advertencias.length === 0) {
      ui.alert(
        '‚úÖ Validaci√≥n Exitosa',
        'El sistema est√° correctamente configurado.\n\n' +
        'Revisa el Log (Ver > Registros) para m√°s detalles.',
        ui.ButtonSet.OK
      );
    } else {
      ui.alert(
        '‚ö†Ô∏è Validaci√≥n con Observaciones',
        `Se encontraron:\n` +
        `‚Ä¢ ${resultado.errores.length} errores cr√≠ticos\n` +
        `‚Ä¢ ${resultado.advertencias.length} advertencias\n\n` +
        'Revisa el Log (Ver > Registros) para m√°s detalles.',
        ui.ButtonSet.OK
      );
    }
  } catch (e) {
    // Si no se puede acceder a UI (ejecutando desde editor), solo mostrar en log
    Logger.log('‚ÑπÔ∏è  Popup no disponible (ejecutando desde editor)');
    Logger.log('üìù Revisa el reporte completo arriba ‚òùÔ∏è');
  }
}

/**
 * Funci√≥n auxiliar: Verificar si existe una funci√≥n espec√≠fica
 */
function existeFuncion(nombreFuncion) {
  try {
    return typeof this[nombreFuncion] === 'function';
  } catch (error) {
    return false;
  }
}

/**
 * Funci√≥n de prueba r√°pida - Solo verifica lo esencial
 */
function validacionRapida() {
  Logger.log('‚ö° Validaci√≥n R√°pida...');
  
  const checks = [
    { nombre: 'doGet', tipo: 'CR√çTICO' },
    { nombre: 'obtenerConfiguracion', tipo: 'CR√çTICO' },
    { nombre: 'obtenerCasosPorHoja', tipo: 'IMPORTANTE' },
    { nombre: 'crearNuevoCaso', tipo: 'IMPORTANTE' }
  ];
  
  let erroresCriticos = 0;
  
  checks.forEach(check => {
    const existe = typeof this[check.nombre] === 'function';
    const icon = existe ? '‚úÖ' : '‚ùå';
    Logger.log(`${icon} [${check.tipo}] ${check.nombre}`);
    
    if (!existe && check.tipo === 'CR√çTICO') {
      erroresCriticos++;
    }
  });
  
  if (erroresCriticos === 0) {
    Logger.log('\n‚úÖ Validaci√≥n r√°pida OK');
  } else {
    Logger.log(`\n‚ùå ${erroresCriticos} error(es) cr√≠tico(s) encontrado(s)`);
  }
}

/**
 * Men√∫ personalizado para ejecutar validaciones
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üîç Validador QA')
    .addItem('‚ñ∂Ô∏è Validaci√≥n Completa', 'validarSistemaCompleto')
    .addItem('‚ö° Validaci√≥n R√°pida', 'validacionRapida')
    .addSeparator()
    .addItem('üìã Ver √∫ltimo reporte', 'mostrarUltimoReporte')
    .addToUi();
}

/**
 * Muestra informaci√≥n del √∫ltimo reporte (placeholder)
 */
function mostrarUltimoReporte() {
  SpreadsheetApp.getUi().alert(
    'Ejecuta "Validaci√≥n Completa" y revisa el Log:\n' +
    'Ver > Registros (Ctrl+Enter)'
  );
}
